# JVM内存区域划分:

![IMG_B49A38E9B6B7-1](JVM.assets/IMG_B49A38E9B6B7-1.jpeg)







# 一、内存管理



## 1. 程序计数器

- 程序计数器: Program Counter Register

用于记录当前线程执行字节码的`行号`

字节码的解释器在执行字节码文件中的指令时，会修改字节码的行号，修改后的值就指向下一条即将执行的指令



Java执行多线程程序是基于轮转算法的，CPU的一个核心在某一时刻时只会执行一个线程，线程的时间片消耗完后，就会自动切换到其他的线程，而当前线程目前执行到位置会以行号的形式存放在**线程独有的程序计数器中**

> 下次再运行当前线程时，则从程序计数器中得知继续运行的位置
>
> 程序计数器所占空间较小

<hr>











## 2. 虚拟机栈/本地方法栈

- 虚拟机栈(VM Stack):

> 作为一个栈结构，存储每个方法对应的栈帧(局部变量表、操作数栈、动态连接、方法出口)

其中动态链接是指当前方法中调用的其他方法，通过该类的常量池可以找到对应方法的符号引用，然后将该符号引用转换为对方法的直接引用

最后方法出口规定了方法该如何结束



Eg:

![Xnip2022-06-12_15-01-17](JVM.assets/Xnip2022-06-12_15-01-17.jpg)



![Xnip2022-06-12_15-02-06](JVM.assets/Xnip2022-06-12_15-02-06.jpg)



每个方法调用的时候，其对应的信息封装为栈帧放入栈中，方法运行结束后再出栈:

![Xnip2022-06-12_15-04-21](JVM.assets/Xnip2022-06-12_15-04-21.jpg)



![Xnip2022-06-12_15-05-04](JVM.assets/Xnip2022-06-12_15-05-04.jpg)





- 本地方法栈:

> 作用同虚拟机栈相同，但其存放的是本地方法对应的栈帧

<hr>









## 3. 堆/方法区

- 堆:

> 对象的存储和管理区域，垃圾回收的主要作用区域，是JVM中最大的内存空间





- 方法区:

> (在JDK7之前)：由类信息表和运行时常量池组成

类信息表:

用于存储每个类对应的版本、字段、方法、接口等信息，同时会将编译时生成的类常量池数据存储在运行时常量池中

>类常量池也称作静态常量池



结构:

![Xnip2022-06-12_15-31-14](JVM.assets/Xnip2022-06-12_15-31-14.jpg)





测试1:

- 使用new关键字创建的对象会放在`堆`中，所以两个对象对应的地址值不同，调用`==`比较的结果自然为false
- 而字符`abc`存放在方法区中的运行时常量池中，所以调用`equals`方法比较内容时，结果相同

![Xnip2022-06-12_15-32-54](JVM.assets/Xnip2022-06-12_15-32-54.jpg)

![Xnip2022-06-12_15-39-04](JVM.assets/Xnip2022-06-12_15-39-04.jpg)







- 使用""对应的字符串字面量时，会直接引用方法区中的字符串:

![Xnip2022-06-12_15-40-10](JVM.assets/Xnip2022-06-12_15-40-10.jpg)

![Xnip2022-06-12_15-40-42](JVM.assets/Xnip2022-06-12_15-40-42.jpg)









- 通过String实例调用`intern`方法会直接返回该实例引用的字符串常量在方法区中的地址:

![Xnip2022-06-12_15-42-05](JVM.assets/Xnip2022-06-12_15-42-05.jpg)

intern方法的机制:

- 检查当前String实例对应的字符串是否存在于方法区内的运行时常量池中，存在则返回其中的地址，不存在则将该字符串放入运行时常量池中再返回对应的地址

Eg:

![Xnip2022-06-12_15-44-33](JVM.assets/Xnip2022-06-12_15-44-33.jpg)









变化:

- 从JDK7开始，调用intern方法后，如果运行时常量池中没有对应的字符，则运行时常量池中会直接存储该字符串在堆中的引用:

![Xnip2022-06-12_15-57-18](JVM.assets/Xnip2022-06-12_15-57-18.jpg)



Eg:

![Xnip2022-06-12_15-59-31](JVM.assets/Xnip2022-06-12_15-59-31.jpg)



注意:

> JDK7之后，字符串常量池移动到了堆中

<hr>









## 4. 总结

- 程序计数器(线程独有): 记录当前线程执行的位置
- 虚拟机栈(线程独有): 存储栈帧来维持方法的调用顺序，控制程序有序运行
- 本地方法栈(线程独有): 作用同虚拟机栈，作用于本地方法
- 堆: 存储和管理所有的对象(包括数组)，JDK7之后其中还含有字符串常量池
- 方法区: 存储类信息、代码缓存、运行时常量池























