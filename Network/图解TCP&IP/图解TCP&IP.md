# 一、TCP/IP基础



## 1. TCP/IP标准化







### 1) TCP/IP具体含义

> 利用IP进行通信时用到的协议群的统称



![IMG_C94CAA28F9FA-1](图解TCP&IP.assets/IMG_C94CAA28F9FA-1.jpeg)

<hr>







### 2) RFC获取

- TCP/IP协议中需要标准化的，被列入到了RFC文档中(Request For Comment)



获取RFC文档:

[» RFC Editor (rfc-editor.org)](https://www.rfc-editor.org/)

[Index of /rfc (rfc-editor.org)](https://www.rfc-editor.org/rfc/)

<hr>







## 2. TCP/IP协议分层模型





### 1. 物理层

- 即负责数据传输的硬件

<hr>





### 2. 网络接口层(数据链路层)

- 负责让硬件起作用

<hr>







### 3. 互联网层(网络层)

- 网络层使用IP协议，IP协议基于IP地址转发分组的数据

> 网络层和传输层的功能一般由操作系统提供，比如路由器，其必须实现通过网络层转发分组数据的功能
>
> 连接互联网的所有主机/路由器都必须实现IP的功能





#### IP

- IP在跨越网络传送数据包时，使用IP地址作为主机的标识
- IP还隐含数据链路层的功能，通过IP，互相通信的主机无论经过怎样的数据链路底层，都能实现通信

> IP协议不具备重发机制，属于非可靠传输协议





#### ICMP

- 当IP数据包在发送途中一旦发生异常无法正常到达，则需要会给发送端发送一个正常的通知

> 有时也被用来诊断网络的健康状况





#### ARP

- 从数据包的IP地址中解析出MAC地址

<hr>











### 4. 传输层

功能:

- 让应用程序之间能够通信，识别应用程序的是端口号







#### TCP

- 面向有连接的传输层协议
- TCP可以正确处理传输过程中的丢包、传输顺序乱掉等异常情况，还能利用带宽缓解网络拥堵
- TCP为了建立连接，需要多次进行数据包的收发

> TCP不适用于对时效性要求高的应用







#### UDP

- UDP是一种面向无连接的传输层协议

> UDP常用于多媒体领域

<hr>











### 5. 应用层

- 会话层、表示层和应用层的功能都集中在应用程序中



#### WWW

协议: HTTP(应用层协议)

数据格式: HTML





#### 电子邮件

协议: SMTP(simple mail transfer protocol)

数据格式: 文本(以前)，MIME协议拓展: 声音、图像等信息



MIME(表示层协议)









#### 文件传输(FTP)

- FTP进行文件传输时，会建立两个TCP连接(发送传输请求时用的控制连接，实际传输数据的数据连接)







#### 远程登录(TELNET/SSH)

- TCP/IP中远程登录常用TELNET和SSH协议









#### 网络管理(SNMP)

在TCP/IP中进行网络管理时，采用SNMP(simple network management protocol)

<hr>











## 3. TCP/IP分层模型和示例





### 1) 数据包首部

![IMG_323DEFAFE1B0-1](图解TCP&IP.assets/IMG_323DEFAFE1B0-1.jpeg)



Terminology:

- 帧: 表示**数据链路层**中，**包的单位**
- 数据包: **网络层以上层级中**，包的单位
- 段: TCP数据流中的信息
- 消息: 应用协议中数据的单位

<hr>









### 2) 经过数据链路的包

- 每个包首部中至少包含两个信息: 
    - 发送端和接收端的地址
    - 上一层的协议类型

<hr>









### 3) 数据包接收处理

接收流程是发送流程的逆序过程



1. 数据链路层(网络接口层)

从包首部中找到MAC地址判断是否是给自己的包，不是则丢弃

如果是，则查看类型域，确定数据类型(IP、ARP协议)





2. 网络层IP

判断包首部的IP地址是否与自己的匹配，是则接收数据并查找上一层

如果不是，则需要借助路由控制表查询应该转发的路径后，再进行转发





3. 传输层TCP
    - 首先计算一下检验和，判读数据是否被破坏
    - 然后检查是否按照序号接收数据
    - 最后检查端口号，确定具体的应用程序
    - 接收端会发送一个确认回执给给发送端





4. 应用程序处理

<hr>












# 二、IP协议



## 1. 网际协议

- TCP/IP的心脏是网络层

> 网络层主要由IP和ICMP两个协议组成

<hr>







### 1. OSI参考模型第三层

- 除去会话层和表示层，IP相当于OSI参考模型中的第3层——网络层

> 网络层的作用: 实现终端节点之间的通信



- 数据链路层只能在互连的**同一种链路节点之间进行包的传递**
- 一旦跨越了不同种的数据链路，就需要借助网络层来传递数据了(无线与有线，电信号与光信号)

<hr>









### 2. 网络层与数据链路层的关系

- 数据链路层提供直连设备之间的通信
- 网络层的IP则提供没有直连的两个网络之间的通信

<hr>











## 2. IP基础知识

- IP的三大模块:
    1. IP寻址
    2. 路由(转发)
    3. IP分包和组包

<hr>









### 1) IP地址

> 要识别连接在网络中的所有主机，需要使用IP地址作为通信地址

- 所以在TCP/IP通信中的所有主机/路由器都必须设置自己的IP地址

<hr>











### 2) 路由控制

> 是指将数据发送到最终目标地址的功能



- 路由控制确保了数据包能够成功到达最终的目标地址

IP路由也叫多跳路由，每个区间内决定着包在下一跳被转发的路径

- 多条路由指路由器/主机在转发IP数据包时，只指定下一个路由器或主机，而不是将最终目标地址为止的所有路径都指定出来
- 每个区间在转发IP数据包时，会分别制定下一跳的操作，直到包到达最终的目标地址





路由控制表

- 所有主机都维护着一张路由控制表，该表记录IP数据在下一步应该发送给的路由器，IP包会根据该路由表在各个数据链路上传输

<hr>













### 3) 数据链路层的抽象

IP的重要作用之一:

> 可以将数据链路层上的地址抽象为IP地址，无论底层的数据链路是什么，都一视同仁



不同数据链路之间最大的区别:

- 各自的最大传输单位不同(MTU: Maximun Transmission Unit)



为了解决这个问题，IP会进行分片处理(IP Fragment):

- 将较大的IP包分成多个较小的IP包
- 分片的包到了对端目标地址后，会再被组合起来传递给上层



> IP通过这种方式抽象化了数据链路层，使得上层更不容易得知底层的网络构造

<hr>









### 4) IP无连接

- IP面向无连接:

​	在发送数据包之前，不需要建立与对端目标之间的连接



IP采用面向无连接的原因:

1. 简化: 面向连接更复杂
2. 提速: 每次通信之前都要先建立连接，会降低处理速度

<hr>







## 3. IP地址基础





### 1) 定义

IPv4地址由32位表示，在TCP/IP参与通信的主机都要分配这样一个IP地址



IP地址并非是根据主机台数，而是根据网卡来配置的

<hr>









### 2) IP地址的组成

> IP地址由网络标识(网络地址)和主机标识(主机地址)两个部分组成



- 同一网段内，网络标识必须相同，主机标识不能重复
- 通过网络标识即可判断两台主机是否在同一网段内



为了划分网络标识和主机标识的部分，使用子网掩码即可区分这两个部分

![IMG_49F75F063489-1](图解TCP&IP.assets/IMG_49F75F063489-1.jpeg)

<hr>









### 3) IP地址的分类



- A类地址:

首位以0开头，1到8位为网络标识

即从0.0.0.0到127.0.0.0

后24位为主机标识





- B类地址:

前两位为10，1到16位为网络标识

从128.0.0.1到191.255.0.0

后16位为主机标识





- C类地址:

前三位为110，1到24位为网络标识

从192.168.0.0到239.255.255.0

后8位为主机标识







- D类地址:

前四位为1110，1到32位为网络标识

从224.0.0.0到239.255.255.255

没有主机标识，用于多播



注意事项:

> IP地址不能全部为0或者1
>
> 全为0只有在对应IP地址不可获知的情况下使用
>
> 全为1通常作为广播地址

<hr>









### 4) 广播地址

> 用于在同一个数据链路相互连接的主机之间发送数据包
>
> 将IP地址中的主机地址部分全部设置为1后，就变成了广播地址



- 广播的种类

本地广播: 本网络内的广播

直接广播: 不同网络之间的广播

<hr>











### 5) IP多播

> 多播用于将包发送给特定组内的主机，其直接使用IP协议，所以也是不可靠的



- 使用多播之前，一直使用广播的方式:

将数据发送给所有的主机，再由这些主机IP的上一层来判断是否接受数据

这种方式会给毫无关系的网络/主机带来影响，造成不必要的流量



- 多播可以穿透路由器，可以实现只给必要的组发送数据包







- IP多播/地址

多播使用D类地址

<hr>











### 6) 子网掩码

- 网络标识相同的计算机必须同属于一个链路



子网/子网掩码:

- 通过子网掩码的识别码可以通过网络地址细分出更细的子网地址



- 引入子网后，IP地址有了两种识别码: IP地址本身和网络部分的子网掩码

> 对应IP地址网络标识部分全为1，主机标识部分全为0

- 从此，一个IP地址不再受限于自己的类别，而是通过子网掩码来自由地定位自己的网络长度

两种表示方式:

![IMG_5738544FE81F-1](图解TCP&IP.assets/IMG_5738544FE81F-1.jpeg)

<hr>









### 7) 全局/私有地址

为了不出现IP地址重复后出现地址冲突的问题，出现了一种新技术:

> 不要求每个主机/路由器都分配一个固定的IP地址，而是在必要的时候只为相应数量的设备分配唯一的IP地址



部分主机没有联网需求的话，可以设置对应的私有网络IP地址:

![IMG_FD99D259573D-1](图解TCP&IP.assets/IMG_FD99D259573D-1.jpeg)



- 通过`NAT`技术后，可以互换私有IP和全局IP，从而实现私有网络内的设备连接网络

![IMG_B23DC5F3E97E-1](图解TCP&IP.assets/IMG_B23DC5F3E97E-1.jpeg)

<hr>











## 4. 路由控制

> 数据发送过程中，使用的是IP地址，但发送过程中还需要指明路由器/主机的信息，才能真正地发往目标地址
>
> 保存这种信息的就是`路由控制表`

- 实现IP通信的主机和路由器必须维护一张路由控制表
- 该表由一个`路由协议`的协议制作而成

<hr>















### 1) IP地址/路由控制

> 路由控制表中记录着网络地址与下一步应该发送到路由器的地址

- 发送IP包时，需要首先确定IP包首部的目标地址
- 再从路由控制表中找到对应相同的网络地址记录，根据该记录转发给相应的下一个路由器





默认路由:

- 路由表中任何一个地址都能与之匹配的记录



主机路由:

- 要基于主机网卡上配置的IP来



环回地址:

- 127.0.0.1/localhost

<hr>











### 2) 路由控制表的聚合

> 通过路由信息的聚合可以有效减少路由表的条目
>
> 从而构建大规模、高性能的网络

<hr>













## 5. IP分割处理/再构成



### 1) IP报文的分片和重组

- 当数据包较大时，**路由器需要将报文进行分片**
- 分片重组时，`只能由目标主机进行`，**路由器不进行重组**

<hr>







### 2) 路径MTU发现

分片机制的不足:

> 路由器的负荷重，路由器需要做的处理越来越多
>
> 分片丢失，则整个IP数据作废



为了应对上述问题，产生了新技术——路径MTU发现(Path MTU Discovery)

> 路径MTU: 路径中存在的所有数据链路中最小的MTU



- 通过路径MTU，可以避免中途在路由器上进行分片处理

<hr>









## 6. IPv6



### 1) 特点

- IP地址的扩大与路由控制表的聚合
- 性能提升:

首部长度固定，不再采用首部校验码

- 支持即插即用

没有DHCP服务器也能实现自动分配IP地址

- 采用认证和加密功能
- 多播、Mobile IP成为拓展功能

<hr>









### 2) IP地址的标记方法

> 使用128bit，以16bit为一组，每组用冒号`:`隔开
>
> 如果出现连续的0，可以使用`::`隔开



![IMG_7D9550ECD12C-1](图解TCP&IP.assets/IMG_7D9550ECD12C-1.jpeg)

<hr>







# 三、IP协议相关技术





## 1. 仅靠IP无法完成通信

- 日常使用时，通常只会输入网址，所以`需要将网络应用使用的网址/地址映射为IP地址`
- `在同一条数据链路中，只使用MAC地址传输数据包`，将IP数据包在网络上传输的是数据链路，所以需要知道发送端的MAC地址

<hr>











## 2. DNS

> DNS可以将网址自动转换为对应的IP地址

适用于IPv4和IPv6

<hr>









### 1) IP地址不好记

通常我们不会使用IP地址来访问其他网络应用，而是使用主机域名

- 起初，为了实现将主机名转换为具体的IP地址，主机会使用`hosts`文件来记录所有的主机名和对应的IP地址

但网络规模扩大后，这种方式就不适用了

<hr>









### 2) DNS产生

> DNS系统中，维护一个表示主机名和IP地址对应关系的数据库

当用户输入域名后，会由DNS查询对应的IP地址并快速返回

<hr>













### 3) 域名

域名是一种分层的结构，不同的部分由`.`隔开

- 当出现带有层次结构的域名后，每个组织结构对应的域名里的主机名就可以自由命名了



结构:

![IMG_30692CB4B279-1](图解TCP&IP.assets/IMG_30692CB4B279-1.jpeg)







- 域名服务器

一般指管理域名的主机和相应的软件。其可以管理所在分层的域的相关信息



域名服务器的层次结构:

![IMG_D5B2D7684C17-1](图解TCP&IP.assets/IMG_D5B2D7684C17-1.jpeg)

- 每层都设置有对应的域名服务器
- 每层域名服务器都了解该层及以下分层中所有域名服务器的IP地址
- 从根服务器开始按顺序追踪，可以访问世界上所有域名服务器的地址



如果域名服务器下没有分层，那么就能够自由指定主机名和子网名称，想要修改分层的域名，需要在上层服务器中进行添加/修改

> 所有域名服务器都必须记录根域名服务器的IP地址

<hr>









- 解析器(Resolver)

> 执行DNS查询的主机和软件即为DNS解析器

其需要至少注册一个以上的域名服务器IP地址，其至少包括其所处组织内部的域名服务器IP地址

<hr>











### 4) DNS查询

查询流程示例:

![IMG_1E40F0A476DB-1](图解TCP&IP.assets/IMG_1E40F0A476DB-1.jpeg)



解析器会向当前层的域名服务器进行发送查询请求，如果当前层没有找到，则发送给上层的域名服务器，直到找到指定的数据再返回

- 解析器和域名服务器每次新查询到的信息都会保存到缓存里，从而减少每次查询时的性能损耗

<hr>









## 3. ARP

IP包在发送的时候，需要知道目标地址在数据链路层对应的`MAC`地址





### 1) ARP概要

- ARP协议以IP地址为基础，**可以定位到下一个接收数据分包的网络设备对应的MAC地址**
- 如果目标主机**不在一个数据链路上，则可以通过ARP协议查找下一跳路由器的MAC地址**



ARP协议只适用于IPv4，不能用于IPv6，

<hr>









### 2) ARP的工作机制

- ARP协议是根据ARP请求和ARP响应两种类型的包来确定MAC地址的



Eg:

![IMG_1ACDC63E9D47-1](图解TCP&IP.assets/IMG_1ACDC63E9D47-1.jpeg)



- 其中的主机为了获取目标地址的MAC地址，会通过广播发送一个ARP请求包
- 同一个链路上的所有设备都能接收到这个广播的包
- 如果请求包中的IP地址和收到的设备一致，则这个设备会返回一个带有自己MAC地址的ARP响应包给发送请求包的主机



因为ARP可以动态地进行地址解析，所以在TCP/IP中通信时，只需要知道IP地址即可

> 通常会将获取到的MAC地址进行缓存，从而防止ARP包在网络上大量广播的可能性
>
> 执行一次ARP都会清空缓存

<hr>











### 3) IP和MAC地址

只有通过MAC地址和IP地址才能将数据准确发送，所以转换两者的ARP协议也很重要

<hr>













### 4) RARP

> RARP将ARP协议反过来，可以从MAC地址获取IP地址



当无法动态获取IP的时候，可以使用RAPR协议:

- 假设一台RAPR服务器，该服务器上注册了对应设备的MAC地址和IP地址

![IMG_00A74D5EC133-1](图解TCP&IP.assets/IMG_00A74D5EC133-1.jpeg)

<hr>













### 5) 代理ARP

> 使用代理ARP的服务器可以将ARP请求发送给临近的其他网段，从而实现不同网段间的直接通信

通过路由器控制多个网络，每个网段定义不同的子网，从而进行路由控制

<hr>









## 4. ICMP

Internet Control Message Protocol



### 1) 辅助IP的ICMP

- ICMP的主要功能:

> 确认IP包是否成功送达，通知发送过程中IP包的废弃原因，改善网络设置等等
>
> 负责通知IP包未能成功送达的原因



ICMP通知失败原因的功能会使用IP进行发送



ICMP的消息种类:

1. 通知出错原因的错误消息
2. 诊断的查询消息

![IMG_F19B6095D8FF-1](图解TCP&IP.assets/IMG_F19B6095D8FF-1.jpeg)

<hr>









### 2) 主要的ICMP消息



- 目标不可达消息



- 重定向消息

发生在路由器有更好的路由信息的情况下，路由器会通过ICMP发送给主机一个更适合的发送路由



- 超时消息

当IP包中的TTL减为0时，该IP包会被丢弃，此时会给发送端发送一个ICMP超时的消息



为了避免IP包在网络上无休止地转发





- 回送消息

用于通信的主机、路由器之间，判断数据包是否成功到达

> PING命令就是利用这个消息实现的

<hr>









### 3) ICMPv6

- 在IPv6中，没有ICMPv6，就无法正常通信

> 其中的邻居探索消息功能取代了IPv4中的ARP协议，还融合了ICMP重定向和路由选择信息等功能



- 邻居探索

> IPv6实现了即插即用，在没有DHCP服务器的环境中，也能够实现IP地址的自动获取

<hr>













## 5. DHCP

Dynamic Host Configuration Protocol



### 1) 实现即插即用

> DHCP协议实现了自动设置IP地址，统一管理IP地址的分配

<hr>







### 2) DHCP的工作机制

- 使用DHCP之前，需要架设一个DHCP服务器，并将需要分配的IP设置、子网掩码、路由控制信息和DNS服务器的地址设置到该服务器上



主机从DHCP服务器获取IP的过程:

![IMG_C107A29E867C-1](图解TCP&IP.assets/IMG_C107A29E867C-1.jpeg)



为了防止分配的IP地址重复，进行DHCP通信的客户端和服务器需要具备的功能:

- 服务器: 给即将分配的IP地址发送请求包，确保没有回应(保证该IP没有被分配)
- 客户端: 使用获得的IP地址发送一个ARP请求，确认没有回应(确保该IP之前没有被分配)

<hr>











### 3) DHCP中继代理

小型网络环境中，一般都由宽带路由器充当这个DHCP服务器



但大型网络环境中，则需要统一管理和运维

> 通过DHCP中继代理，可以让不同网段的IP地址分配也能由一个DHCP服务器统一管理和运维
>
> 只需要在每个网段内设置一个DHCP中继代理即可



- 中继代理收到客户端请求后，会通过单播的方式向DHCP服务器发送请求

Eg:

![IMG_5657C018BC7A-1](图解TCP&IP.assets/IMG_5657C018BC7A-1.jpeg)

<hr>













## 6. NAT

Netword Address Translator



### 1) NAT定义

> 用于将本地私有地址转换为全局IP地址



还有可以转换TCP和UDP端口的NAPT技术

- 在IPv4和IPv6之间的通信中，通常使用NAT-PT

<hr>











### 2) NAT的工作机制

- 私有地址通过NAT路由器后，将地址改为全局地址后再发送数据
- 全局地址同样改为私有地址后再发送数据

Eg:

![IMG_2278444194C3-1](图解TCP&IP.assets/IMG_2278444194C3-1.jpeg)



- NAT路由器内部有一张自动生成的用来转换地址的表，可以将私有地址和全局地址按照表中的映射关系进行处理
- 当私有网络中有多台设备时，会使用NAPT将包含的端口号一起转换

Eg:

![IMG_9A968AF30486-1](图解TCP&IP.assets/IMG_9A968AF30486-1.jpeg)

如果端口号重复，还会自动进行修改

<hr>









### 3) NAT-PT(NAPT-PT)

> NAT-PT可以将IPv6的首部转换为IPv4的首部
>
> 从而让只有IPv6地址的主机与IPv4地址通信

![IMG_780CA68D2410-1](图解TCP&IP.assets/IMG_780CA68D2410-1.jpeg)

<hr>











### 4) NAT的潜在问题

NAT技术依赖于自己的转换表，所以存在一些问题:

- 无法从NAT外部向内部建立连接
- 转换表的生成的转换操作需要产生一定开销
- 通信过程一旦NAT路由器重启，所有的TCP连接都要重置
- 即使有集群来做容灾备份，但连接依然会重置

<hr>











### 5) 解决NAT的潜在问题和NAT穿越



解决NAT潜在问题的两种方式:

1. 改用IPv6

改用IPv6后，就不再需要使用NAT了



2. 通过应用代替NAT
    - NAT内侧主机上运行的应用为了生成NAT转换表，会先发送一个虚拟的网络包给NAT外侧

> 这样NAT外侧和内侧也能进行通信了，称为NAT穿越
>
> 但这样的应用比较复杂

<hr>









## 7. IP隧道

> 为了让IPv4和IPv6网络之间进行通信，需要采用IP隧道的功能



对于从IPv6到IPv4:

- 将从IPv6发送过来的数据包统合后，为之追加一个IPv4首部后，转发给IPv4网络



> 通过在网络层首部后面继续追加网络层首部的通信方式就称做`IP隧道`

Eg:

![IMG_3F155BE0AD8E-1](图解TCP&IP.assets/IMG_3F155BE0AD8E-1.jpeg)



构建网络时，对于不同时支持IPv4和IPv6的设备，可以通过IP隧道来转发数据包

<hr>















## 8. 其他





### 1) IP多播

为了确定是否存在接收端，需要使用MLD来实现(Multicast Listener Discovery)，它是IPv4中IGMP和IPv6中ICMPv6中的重要功能

- IGMP: Internet Group Management Protocol



IGMP的两大作用:

1. 向路由器表明想要接收多播消息
2. 向交换集线器通知想要接收多播的地址

<hr>





### 2) IP任播

> 为提供同一服务的服务器配置同一个IP地址，并与最近的服务器进行通信(类似CDN)

- 但其无法保证所有的包都发送给同一个主机

<hr>









### 3) 通信质量控制



- QoS技术可以保证服务质量

<hr>















### 4) 显示拥塞通知

网络发生拥塞时，发送主机应该减少数据包的发送量

> TCP可以控制网络拥塞，但其是通过数据包的实际损坏情况来判断的，不能在数据包损坏前减少数据包的发送量



IP层的`ECN`就是用来解决这个问题的

ECN的机制:

> 在发送包的IP首部中记录路由器是否遇到拥塞，并在返回包的TCP首部中通知是否发生过阻塞

- 在网络层进行拥塞的检查，在传输层进行拥塞的通知

![IMG_DFE9BA938E87-1](图解TCP&IP.assets/IMG_DFE9BA938E87-1.jpeg)

<hr>













### 5) Mobile IP



- 定义

与移动设备进行通信时，一旦其连接的子网发生改变，则无法通过TCP进行通信

> 因为TCP是面向连接的协议，至始至终都需要发送方和接收方的IP地址不变



> Mobile IP可以在主机连接的子网IP发生变化的情况下，主机IP依然不变，从而使得通信得以维系





- IP隧道和Mobile IP

![IMG_5B6FB58BA8C0-1](图解TCP&IP.assets/IMG_5B6FB58BA8C0-1.jpeg)



名词:

移动主机: 

- 移动了位置，IP却不变的设备。

归属代理:

- 处于归属网络下，可监控移动设备的位置，并转发数据包给移动主机



外部代理:

- 支持移动主机的移动设备，适用于所有需要接入网络的移动主机

> 移动后通过外部代理发送转发数据包向归属代理通知自己的地址

<hr>











# 四、TCP/UDP



## 1. 传输层的作用

- TCP提供可靠的通信传输
- UDP常用于将广播和细节控制交给应用的通信传输

<hr>







### 1) 传输层定义

- IP首部中有一个协议字段用来表示传输层使用的协议(传输的是TCP还是UDP的数据)
- TCP和UDP各自为了识别传输的数据部分应该给哪个应用，也会设计一个编号

> 端口号就能够实现识别数据应该传输给哪个具体应用

<hr>











### 2) 通信处理

服务端的应用需要提前启动，准备接收客户端的请求



- 这些服务端程序在UNIX中称为`守护进程`
- UNIX中，不需要将所有的守护进程依次启动，只需要启动一个可以代表它们接收请求的inetd(互联网守护进程)服务器进程即可，其是一个超级守护进程
- 超级守护进程收到客户端请求后，会创建(fork)新的进程再转换(exec)为httpd，sshd等守护进程

> 通过请求数据中的目标端口即可识别发送给的目标服务端应用(守护进程)

<hr>









### 3) 两种传输层协议



- TCP

TCP是面向连接的、可靠的流协议

流: 指不间断的数据结构





- UDP

不具有可靠性传输

细微处理会交给上层的应用去完成，可以确保信息的大小一致，但无法确定消息一定到达

<hr>











### 4) TCP/UDP区别

- TCP用于在传输层**需要实现可靠连接的情况下**
- UDP用于那些**对高速传输和实时性要求有较高的通信或广播通信**

![IMG_546F7EC19727-1](图解TCP&IP.assets/IMG_546F7EC19727-1.jpeg)





注:

- 使用TCP或者UDP通信时，会使用到Socket API

<hr>









## 2. 端口号





### 1) 端口号定义

> 在传输层中，通过端口号来识别一台主机中的各个应用程序，所以也被称为程序地址

<hr>







### 2) 通过IP、端口号、协议号进行通信识别

在TCP/IP或UDP/IP通信中，通常采用5中信息来识别一个通信:

- 源IP地址
- 目标IP地址
- 协议号
- 源端口号
- 目标端口号

Eg:

![IMG_0D176B4992AF-1](图解TCP&IP.assets/IMG_0D176B4992AF-1.jpeg)

<hr>









### 3) 确认端口号

确认端口号的方法有两种:



- 标准既定的端口号

也称为静态方法。是指每个应用程序都有其指定的端口号，广为使用的协议中使用的端口号就是固定的，称为知名端口号





- 时序分配

也叫动态分配法，此时服务端必须监听端口，但客户端可以不确定端口号

- 此时客户端可以让操作系统为应用程序自行分配端口号

<hr>









### 4) 端口号和协议

> 不同的传输协议可以使用同一个端口，数据到达IP层之后，会检查IP首部中的协议号，再传给对应协议的模块

- 即使在同一个端口中，因为传输层协议会各自独立地进行处理，所以相互之间不会受到影响

<hr>













## 3. UDP

User Datagram Protocol



UDP的特点和目的:

> UDP利用IP提供面向无连接的通信服务，其收到数据的一刻会立刻照原样发送到网络中去

- UDP不负责重发，没有纠正功能
- 细节方法交由采用UDP的应用来处理



常用的方面:

- 数据总量少的通信(DNS等)
- 即时通信
- 特定网络中的应用通信
- 广播、多播

<hr>













## 4. TCP

> TCP实现了数据传输时的各种控制功能，可以进行丢包时的重发控制，可以对包进行顺序控制

- TCP是一种面向连接的协议，只有在确认通信对方存在且建立连接后，才会发送数据，进而可以控制通信流量的浪费
- TCP可以在IP这种无连接的网络上实现高可靠的通信
- TCP负责控制连接的建立、断开、保持等工作

<hr>











### 1) TCP的特点和目的

> TCP通过校验和、序列号、确认应答、重发控制、连接管理以及窗口控制等实现可靠性传输

<hr>









### 2) 通过序列号确认应答提高可靠性

- 当确认接收到消息时，会发送一个已收到消息的通知，称做确认应答(ACK/acknowledgement)
- 否定确认应答: NACK/not acknowledgement



TCP通过确认应答来实现可靠的数据传输

如果一段时间内没有接收到确认应答，则认为数据丢失，发送端会进行数据重发

Eg:

![IMG_68220FE34B95-1](图解TCP&IP.assets/IMG_68220FE34B95-1.jpeg)

还有可能是接收端回传的确认应答(ACK)包丢失，或者延迟到达



- 这种重发机制可能会一直向目标主机发送数据，此时目标主机可能会一直丢弃重复的数据包

> 为此，需要一种机制识别是否已经接收数据，还能判断是否需要接收





上述机制总结为: 确认应答处理、重发控制重复控制

- `这些功能都能够通过序列号实现`

序列号通过按照顺序给发送给数据的每个字节标上号码编号

> 接收端查询接收数据TCP首部中的序列号和长度，将自己下一步应该接收的序号作为应答返回



Eg:

![IMG_517B4B55E8B2-1](图解TCP&IP.assets/IMG_517B4B55E8B2-1.jpeg)

<hr>











### 3) 确定重发超时

重发超时:

- 重发数据之前，等待确认应答到来的那个等待时间间隔

<hr>











### 4) 管理连接

> TCP在通信之前，会通过TCP发送一个SYN包作为建立连接的请求等待确认应答

通信结束后，会进行断开连接的处理(FIN包)



一般通过TCP首部字段来管理TCP连接

- 一个连接的建立与断开一般需要来回发送7个包(三次握手、四次挥手)

Eg:

![IMG_AFF130EDF5FD-1](图解TCP&IP.assets/IMG_AFF130EDF5FD-1.jpeg)

<hr>













### 5) 以段为单位发送数据

- 建立TCP连接的同时，可以确定发送数据包的大小单位，称为最大消息长度(MSS: Maximum Segment Size)

TCP传输大量数据时，会以MSS的大小进行分割发送，重发也是如此



MSS:

> 在三次握手时，在两端主机之间被计算得出
>
> 发送建立连接的请求后，会在TCP首部中写入MSS选项，并写入自己能够适应的MSS大小
>
> 最后会取两端中的较小值来使用



Eg:

![IMG_57E2CCB3BFA3-1](图解TCP&IP.assets/IMG_57E2CCB3BFA3-1.jpeg)

<hr>









### 6) 利用窗口控制提高速度

> TCP以一个段为单位发送数据，每次发送一个段都要进行一次确认应答的处理

- 这样的传输方式有一个缺点: 

包的往返时间越长，通信性能越低，网络吞吐量越差



Eg:

![IMG_DB6F266726D4-1](图解TCP&IP.assets/IMG_DB6F266726D4-1.jpeg)



> 为了解决这个问题，TCP引入了窗口的概念，使得在往返时间较长的情况下，也依然能够控制网络性能的下降



即:

> 应答方/服务器:
>
> 













